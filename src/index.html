<!DOCTYPE html>
<html>
<head>
  <title>News Minimalist Reader</title>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="News Minimalist Reader" />
  <meta name="theme-color" content="#000A16" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#FFFFFF" media="(prefers-color-scheme: light)" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"
  />
  <link rel="icon" href="favicon.png" />
  <link rel="stylesheet" href="index.css" />
  <link rel="apple-touch-icon" href="appicon.png" />
</head>
<body>
  <script>
    const KEY = 'news-minimalist'

    const getText = (item, tag) => item.getElementsByTagName(tag)[0].textContent

    const onClick = (id) => ({ target }) => {
      const allItems = JSON.parse(localStorage.getItem(KEY))

      localStorage.setItem(
        KEY,
        JSON.stringify({ ...allItems, [id]: { ...allItems[id], read: true } })
      )

      target.getElementsByTagName('summary')[0].classList.remove('unread')
    }

    const render = (items) => {
      document.body.innerHTML = items.map((item) => `
        <header></header>
        <details name="feed" ontoggle="onClick('${item.id}')(event)">
          <summary class="${item.read ? '' : 'unread'}">${item.title}</summary>
          <p>
            <i>${item.date.split('T')[0].split('-').reverse().join('/')}</i>
            ${item.content}
          </p>
        </details>
      `).join('')
    }

    fetch('https://nameless-bread-889b.jbonigomes.workers.dev/')
      .then((response) => response.text())
      .then((text) => {
        const parser = new DOMParser()
        const xmlDoc = parser.parseFromString(text, 'application/xml')

        const localItems = JSON.parse(localStorage.getItem(KEY) ?? '{}')
        const fetchedItems = [...xmlDoc.getElementsByTagName('item')]
          .filter((item) => !localItems[getText(item, 'guid')])
          .reduce((acc, cur) => ({
            ...acc,
            [getText(cur, 'guid')]: {
              read: false,
              title: getText(cur, 'title'),
              content: getText(cur, 'content:encoded'),
              date: (new Date(getText(cur, 'pubDate'))).toJSON(),
            },
          }), {})

        const allItems = Object
          .entries({ ...fetchedItems, ...localItems })
          .map(([id, item]) => ({ id, ...item }))
          .toSorted((a, b) => b.date.localeCompare(a.date))
          .slice(0, 50)

        const read = allItems.filter(({ read }) => read)
        const unread = allItems.filter(({ read }) => !read)

        localStorage.setItem(KEY, JSON.stringify(allItems.reduce((acc, cur) => ({ ...acc, [cur.id]: cur }), {})))

        render([...unread, ...read])
      })
  </script>
</body>
</html>
